<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/icon type" href="/images/logo.svg" />
    <title>Amica Expenses</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;500;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="main.css" />

    <script src="app.js" defer></script>
</head>

<body>
    <div class="preloader">
        <img src="/images/load.gif" alt="preloader" class="preloader__item" />
    </div>
    <header>
        <div class="header--menu">
            <li class="hamburger">
              <div class="sidebar-toggle">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </li>

            <div class="header--info">
                <h3>Expenses</h3>
                <div class="header--info hide">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="header--image">
                    <p><span class="username"></span></p>
                </div>
            </div>

            <div class="header--notification">
                <a href="/main/notification.html"> <img src="/images/notification.svg" alt="" /></a>
                <img src="/images/blank-profile-picture-973460_1280.webp" class="notification--img">
            </div>

        </div>
        </div>
        </div>
        <div class="header--sreach">
            <img src="/images/ic_round-search.png" id="searchBtn" alt="search" width="40px" />
            <input type="search" name="sreach" id="search" placeholder="search" />
            <div class="header--addstock">
                <button class="sales">New Expense</button>
            </div>
        </div>
    </header>

    <aside>
        <div class="dashBoard">

            <div class="dashboard--logo">
                <img src="/images/amicafulllogo.svg" alt="logo" />
            </div>
            <div class="dashBoard-items">
                <ul>
                    <li class="d-flex">
                        <img src="/images/icon-park-outline_dashboard-one.png" alt="" />
                        <a href="/main/dashBoard.html">DashBoard</a>
                    </li>
                    <li class="d-flex ">
                        <img src="/images/fluent_tray-item-remove-24-regular.png" alt="" />
                        <a href="/main/item.html">Items</a>
                    </li>
                    <li class="d-flex ">
                        <img src="/images/Vector.png" alt="" />
                        <a href="/main/sales.html">Sales</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/Vector2.png" alt="" />
                        <a href="/main/invoice.html">Invoice</a>
                    </li>
                    <li class="d-flex active">
                        <img src="/images/icon-park-outline_expenses-one.png" alt="" />

                        <a href="/main/expenses.html">Expenses</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/material-symbols_monitor-weight-loss-outline-sharp.png" alt="" />
                        <a href="/main/profit.html">Profit and Loss</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/settings_24px.png" alt="" />
                        <a>Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <main>
        <div class="main--heading">
            <!-- <a class="main-a">Availble Stock</a> -->
            <!-- <a href="/main/remaining.html">Out of stock</a> -->
        </div>
        <div class="table--body">
            <table class="list" id="sales-list">
                <thead>
                    <tr>
                        <!-- <th>DATE</th> -->
                        <th>DESCRIPTION</th>
                        <th>QUANTITY</th>
                        <th>PRICE</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- popup -->
        <div class="popup-container--sales">
            <form class="popup" onsubmit="onFormSubmit()">
                <div class="popoup--head">
                    <img src="/images/Close_MD2.png" alt="" class="salespopup--close">
                </div>
                <h2 id="popup-title">New Expenses</h2>
                <label for="stock-name">Add name*</label><label class="validation-error hide--sales"
                    id="fullNameValidationError"> this
                    field is requried</label>

                <input type="text" id="sales-name" name="sales-name">


                <label for="sales-type">
                    Add description
                    <input type="text" id="sales-type" name="sales-type">
                </label>

                <label for="sales-quantity">
                    Add quantity
                    <input type="text" id="sales-quantity" name="sales-quantity">
                </label>

                <label for="sales-price">
                    Add Price
                    <input type="number" id="sales-price" name="sales-price">
                </label>
                <input id="popup-btn" type="submit" value="submit" class="sales-save">
            </form>


        </div>


        <!-- table -->

    </main>
    <aside>
        <div class="profile">
            <div class="profile--close"><img src="/images/Close_MD2.png" alt=""></div>
            <div class="profile-insert">
                <input type="file" id="file" accept="image/jpeg, image/png, image/jpg">
                <label for="file"><img src="/images/icons8-cameras-48.png" alt="" class="profile-input"></label>
                <div class="profile--top">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="profile--pic">
                </div>
                <div>
                    <h3 class="profile--username ">Deborah Allen</h3>
                    <p class="profile--email">deborahallen@gmail.com</p>
                </div>

            </div>
            <div>
                <ul>
                    <li class="profile--item">
                        <img src="/images/ri_notification-4-line.png" alt="" />
                        <p>Manage notifications</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_privacy-tip-outline-rounded.png" alt="" />
                        <p>Private Policy</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li class="profile--item">

                    <li class="profile--item">
                        <img src="/images/material-symbols_conditions.png" alt="" />
                        <p>Terms and Conditions</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_contact-support-outline-rounded.png" alt="" />
                        <p>Support</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item logout">
                        <img src="/images/ic_round-logout.png" alt="" />
                        <p> Logout</p>
                    </li>
                </ul>
            </div>
        </div>
    </aside>

<script>
        // GET ELEMENTS
        const salesForm = document.querySelector(".popup-container--sales");
        const salesBtn = document.querySelector(".sales");
        const salesCloseBtn = document.querySelector(".salespopup--close")
        const salesSaveBtn = document.querySelector(".sales-save")
        const table = document.getElementById("sales-list")
        const form = document.querySelector(".popup")
        const getuserId = localStorage.getItem("user");
        const userId = JSON.parse(getuserId);
        const tbody = table.getElementsByTagName("tbody")[0];
        salesBtn.addEventListener("click", () => {

            salesForm.classList.add("show--sales");

        });
        salesCloseBtn.addEventListener("click", () => {

            salesForm.classList.remove("show--sales");
        });


        form.addEventListener("submit", (e) => {
            e.preventDefault()
        })
        // Load data from localStorage
        const salesData = JSON.parse(localStorage.getItem("salesData")) || [];
        salesData.forEach((data) => {
            insertFormData(data);
        });


        // Update the onFormSubmit function to send a POST request for adding an expense
function onFormSubmit() {

    if (validate()) {
        const expenseData = {
            description:"lmao",
            name: document.getElementById("sales-name").value,
            type: document.getElementById("sales-type").value,
            quantity: parseFloat(document.getElementById("sales-quantity").value),
            price: parseFloat(document.getElementById("sales-price").value),
            userId: userId._id // Add the user ID
        };

        addExpense(expenseData);
    }
}


    
// Function to add an expense via API
    function addExpense(expenseData) {
    fetch(`https://amica-a.onrender.com/expenses/${userId._id}/add`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(expenseData),
    })
        .then((response) => response.json())
        .then((data) => {
            // console.log(data);
            // Add the added expense to the UI
            // insertExpenseData(data);
            resetForm();
            salesForm.classList.remove("show--sales");
        })
        .catch((error) => {
            console.error("Error adding expense:", error);
        });
}
        function readFormData() {
            let salesinfo = {};
            salesinfo["salesname"] = document.getElementById("sales-name").value;
            salesinfo["salestype"] = document.getElementById("sales-type").value;
            salesinfo["salesquantity"] = document.getElementById("sales-quantity").value;
            salesinfo["salesprice"] = document.getElementById("sales-price").value;
            salesinfo["salesdate"] = document.getElementById("date").value;
            return salesinfo;
        }
        function insertFormData(data) {
            let newRow = tbody.insertRow(tbody.length);
            cell1 = newRow.insertCell(0);
            cell1.innerHTML = data.salesname;
            cell2 = newRow.insertCell(1);
            cell2.innerHTML = data.salestype;
            cell3 = newRow.insertCell(2);
            cell3.innerHTML = data.salesquantity;

            cell4 = newRow.insertCell(3);
            cell4.innerHTML = data.salesprice;
            cell5 = newRow.insertCell(4);
            cell5.innerHTML = data.salesdate;
            cell6 = newRow.insertCell(5);
            cell6.innerHTML = `<img onClick="onDelete(this)" src="/images/Close_MD2.png" alt="" class="popup--close">`;

        }
        function resetForm() {
            document.getElementById("sales-name").value = "";
            document.getElementById("sales-quantity").value = "";
            document.getElementById("sales-type").value = "";
            document.getElementById("sales-price").value = "";
            // document.getElementById("date").value = "";
            location.reload()

        }
        function onDelete(td) {
            if (confirm("Are you sure you want to delete this record?")) {
                row = td.parentElement.parentElement;
                tbody.deleteRow(row.rowIndex - 1, 1);
                console.log(row)
                resetForm();

                // Remove data from localStorage
                const salesData = JSON.parse(localStorage.getItem("salesData")) || [];
                salesData.splice(row.rowIndex - 0, 1);
                localStorage.setItem("salesData", JSON.stringify(salesData));
            }
        }

        function validate() {
            isValid = true;
            if (document.getElementById("sales-name").value == "") {
                isValid = false;
                document.getElementById("fullNameValidationError").classList.remove("hide--sales");
            } else {
                isValid = true;
                if (
                    document
                        .getElementById("fullNameValidationError")
                        .classList.contains("hide--sales")
                )
                    document.getElementById("fullNameValidationError").classList.add("hide--sales");
            }
            return isValid;
        }

        document.addEventListener('DOMContentLoaded', () => {
  // DOM elements
  const expensesTable = document.getElementById('expenses-list');
  const getuserId = localStorage.getItem("user");
  const userId = JSON.parse(getuserId);
  // Fetch all expenses
  fetch(`https://amica-a.onrender.com/expenses/${userId._id}/all`)
    .then(response => response.json())
    .then(expenses => {
        console.log(expenses);
      // Process the fetched expenses data
      expenses.forEach(expense => {
        // Populate your UI with the fetched expense data
        insertExpenseData(expense);
      });
    })
    .catch(error => {
      console.error('Error fetching expenses:', error);
    });

  // Function to insert fetched expense data into the table
  function insertExpenseData(expense) {
    const months = [
  "Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];


    let newRow = table.insertRow(table.rows.length);
    const { time, _id ,  name, quantity, price } = expense;
    const day = new Date(time).getDate()
    const month = new Date(time).getMonth()
    const year = new Date(time).getFullYear()
    const date = `${day} ${months[month]} ${year}`
    newRow.innerHTML = `
      <td>${name}</td>
      <td>${quantity}</td>
      <td>${price}</td>
      <td>
        <img onclick="deleteExpense('${_id}')" src="/images/Close_MD2.png" alt="" class="popup--close">
      </td>
    `;
  }

});
// Function to delete an expense
function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense?')) {
      fetch(`https://amica-a.onrender.com/expenses/${expenseId}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          console.log(data); // Data indicating that expense was deleted
          resetForm()
          // Remove the deleted expense from the UI
          const rowToDelete = document.querySelector(`[data-id="${expenseId}"]`);
          if (rowToDelete) {
            rowToDelete.remove();
          }
        })
        .catch(error => {
          console.error('Error deleting expense:', error);
        });
    }
  }
    </script>
</body>

</html>