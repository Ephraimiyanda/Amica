<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/icon type" href="/images/logo.svg" />
    <title>Amica Sales</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;500;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="main.css" />

    <script src="app.js" defer></script>
</head>

<body>
    <div class="preloader">
        <img src="/images/load.gif" alt="preloader" class="preloader__item" />
    </div>
    <header>
        <div class="header--menu">
            <li class="hamburger">
              <div class="sidebar-toggle">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </li>

            <div class="header--info">
                <h3>Sales</h3>
                <div class="header--info hide">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="header--image">
                    <p><span class="username"></span></p>
                </div>
            </div>

            <div class="header--notification">
                <a href="/main/notification.html"> <img src="/images/Group 595.png" alt="" /></a>
                <img src="/images/blank-profile-picture-973460_1280.webp" class="notification--img">
            </div>

        </div>
        </div>
        </div>
        <div class="header--sreach">
            <img src="/images/ic_round-search.png" id="searchBtn" alt="search" width="40px" />
            <input type="search" name="sreach" id="search" placeholder="search" />
            <div class="header--addstock">
                <button class="sales">New Sale</button>
            </div>
        </div>




    </header>
    <aside>
        <div class="dashBoard">

            <div class="dashboard--logo">
                <img src="/images/amicafulllogo.svg" alt="logo" />
            </div>
            <div class="dashBoard-items">
                <ul>
                    <li class="d-flex">
                        <img src="/images/icon-park-outline_dashboard-one.png" alt="" />
                        <a href="/main/dashBoard.html">DashBoard</a>
                    </li>
                    <li class="d-flex ">
                        <img src="/images/fluent_tray-item-remove-24-regular.png" alt="" />
                        <a href="/main/item.html">Items</a>
                    </li>
                    <li class="d-flex active">
                        <img src="/images/Vector.png" alt="" />
                        <a href="/main/sales.html">Sales</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/Vector2.png" alt="" />
                        <a href="/main/invoice.html">Invoice</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/icon-park-outline_expenses-one.png" alt="" />
                        <a href="/main/expenses.html">Expenses</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/material-symbols_monitor-weight-loss-outline-sharp.png" alt="" />
                        <a href="/main/profit.html">Profit and Loss</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/settings_24px.png" alt="" />
                        <a>Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <main>
        <div class="main--heading">
            <!-- <a class="main-a">Availble Stock</a> -->
            <!-- <a href="/main/remaining.html">Out of stock</a> -->
        </div>
        <div class="table--body">
            <table class="list" id="sales-list">
                <thead>
                    <tr>
                        <th>NAME</th>
                        <th>QUANTITY</th>
                        <th>PRICE</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <!-- popup -->
        <div class="popup-container--sales">
            <form class="popup">
                <div class="popoup--head">
                    <img src="/images/Close_MD2.png" alt="" class="salespopup--close">
                </div>
                <h2 id="popup-title">New Sale</h2>
                <label for="stock-name">Add name*</label><label class="validation-error hide--sales"
                    id="fullNameValidationError"> this
                    field is requried</label>

                <input type="text" id="sales-name" name="sales-name">


                <label for="sales-type">
                    Add type
                    <input type="text" id="sales-type" name="sales-type">
                </label>

                <label for="sales-quantity">
                    Add quantity
                    <input type="text" id="sales-quantity" name="sales-quantity">
                </label>
                <input id=" " type="submit" value="Submit" class="sales-save">
            </form>


        </div>


        <!-- table -->

    </main>
    <aside>
        <div class="profile">
            <div class="profile--close"><img src="/images/Close_MD2.png" alt=""></div>
            <div class="profile-insert">
                <input type="file" id="file" accept="image/jpeg, image/png, image/jpg">
                <label for="file"><img src="/images/icons8-cameras-48.png" alt="" class="profile-input"></label>
                <div class="profile--top">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="profile--pic">
                </div>
                <div>
                    <h3 class="profile--username ">Deborah Allen</h3>
                    <p class="profile--email" >deborahallen@gmail.com</p>
                </div>

            </div>
            <div>
                <ul>
                    <li class="profile--item">
                        <img src="/images/ri_notification-4-line.png" alt="" />
                        <p>Manage notifications</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_privacy-tip-outline-rounded.png" alt="" />
                        <p>Private Policy</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li class="profile--item">

                    <li class="profile--item">
                        <img src="/images/material-symbols_conditions.png" alt="" />
                        <p>Terms and Conditions</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_contact-support-outline-rounded.png" alt="" />
                        <p>Support</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item logout">
                        <img src="/images/ic_round-logout.png" alt="" />
                        <p> Logout</p>


                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <script>
        // GET ELEMENTS
        const salesForm = document.querySelector(".popup-container--sales");
        const salesBtn = document.querySelector(".sales");
        const salesCloseBtn = document.querySelector(".salespopup--close")
        const salesSaveBtn = document.querySelector(".sales-save")
        const table = document.getElementById("sales-list")
        const form = document.querySelector(".popup")
        const tbody = table.getElementsByTagName("tbody")[0];
        const userId=localStorage.getItem("user")

        salesBtn.addEventListener("click", () => {
            salesForm.classList.add("show--sales");

        });
        salesCloseBtn.addEventListener("click", () => {

            salesForm.classList.remove("show--sales");
        });

salesForm.addEventListener('submit', (e) => {
    e.preventDefault();
    onFormSubmit();
});

function onFormSubmit() {
    const getuserId = localStorage.getItem("user");
    const userId = JSON.parse(getuserId);
    const salesInfo = {
        user: userId._id,
        name: document.getElementById("sales-name").value,
        type: document.getElementById("sales-type").value,
        quantity: parseInt(document.getElementById("sales-quantity").value),
    };
    console.log(salesInfo);
    // Disable the submit button to prevent multiple submissions
    salesForm.querySelector(".sales-save").disabled = true;
    // Make a POST request to the API endpoint
    fetch(`https://amica-a.onrender.com/sales/${userId._id}/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(salesInfo)
    })
    .then(response => response.json())
    .then(newSale => {
        // Close the popup
        location.reload();
        salesForm.classList.remove('show--sales');
    })
    .catch(error => {
        console.error('Error adding new sale:', error);
        // Re-enable the submit button in case of an error
        salesForm.querySelector(".sales-save").disabled = false;
    });
}




        function validate() {
            isValid = true;
            if (document.getElementById("sales-name").value == "") {
                isValid = false;
                document.getElementById("fullNameValidationError").classList.remove("hide--sales");
            } else {
                isValid = true;
                if (
                    document
                        .getElementById("fullNameValidationError")
                        .classList.contains("hide--sales")
                )
                    document.getElementById("fullNameValidationError").classList.add("hide--sales");
            }
            return isValid;
        }

        // search
        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.querySelector("#search");
            const tableBody = document.getElementById("tbody");


            const rows = Array.from(tableBody.getElementsByTagName("tbody"));

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase();
                const escapedQuery = RegExp.escape(query);

                rows.forEach((row) => {
                    const cells = row.querySelectorAll("td");
                    let found = false;

                    cells.forEach((cell) => {
                        const value = cell.textContent.toLowerCase().replace(",", "");

                        if (value.search(new RegExp(escapedQuery)) !== -1) {
                            found = true;
                        }
                    });

                    if (found) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            });
        });

        // Polyfill for RegExp.escape() method
        if (!RegExp.escape) {
            RegExp.escape = function (string) {
                return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
            };
        }


        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const salesTable = document.getElementById('tbody');

            const getuserId = localStorage.getItem("user");
            const userid = JSON.parse(getuserId);
            // Fetch all sales
            fetch(`https://amica-a.onrender.com/sales/${userid._id}/all`)
                .then(response => response.json())
                .then(sales => {
                    console.log(sales)
                    // Process the fetched sales data
                    sales.forEach(sale => {
                        insertSaleData(sale);
                    });
                })
                .catch(error => {
                    console.error('Error fetching sales:', error);
                });

            // Function to insert fetched sale data into the table
            function insertSaleData(sale) {
                let newRow = salesTable.insertRow(salesTable.rows.length);
                const { _id, name, quantity, price, time } = sale;
                newRow.setAttribute("data-id", _id)
                newRow.innerHTML = `
                    <td>${name}</td>
                    <td>${quantity}</td>
                    <td>${price}</td>
                    <td>
                        <img onClick="deleteSale('${_id}')" src="/images/Close_MD2.png" alt="" class="popup--close">
                    </td>
                `;
            }

            
        });
        // Function to delete a sale
        function deleteSale(saleId) {
                if (confirm('Are you sure you want to delete this sale?')) {
                    fetch(`https://amica-a.onrender.com/sales/${saleId}`, {
                        method: 'DELETE'
                    })
                        .then(response => response.json())
                        .then(data => {
                            const rowToDelete = document.querySelector(`[data-id="${saleId}"]`);
                            console.log('Succes');
                            if (rowToDelete) {
                                rowToDelete.remove();
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting sale:', error);
                        });
                }
            }
    </script>
</body>

</html>
