<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/icon type" href="/images/amicalogo.png" />

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;500;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="main.css" />

    <script src="app.js" defer></script>
</head>

<body>
    <div class="preloader">
        <img src="/images/load.gif" alt="preloader" class="preloader__item" />
    </div>
    <header>
        <div class="header--menu">
            <li class="hamburger">
              <div class="sidebar-toggle">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </li>

            <div class="header--info">
                <h3>Customers</h3>
                <div class="header--info hide">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="header--image">
                    <p><span class="username"></span></p>

                </div>
            </div>



            <div class="header--notification">
                <a href="/main/notification.html"> <img src="/images/notification.svg" alt="" /></a>
                <img src="/images/blank-profile-picture-973460_1280.webp" class="notification--img">
            </div>
        </div>
        </div>
        </div>
        <div class="header--sreach">
            <img src="/images/ic_round-search.png" id="searchBtn" alt="search" width="40px" />
            <input type="search" name="sreach" id="search" placeholder="search" />
            <div class="header--addstock">
                <button class="customer--add">New Customer</button>
            </div>
        </div>




    </header>
    <aside>
        <div class="dashBoard">

            <div class="dashboard--logo">
                <img src="/images/amicafulllogo.svg" alt="logo" />
            </div>
            <div class="dashBoard-items">
                <ul>
                    <li class="d-flex">
                        <img src="/images/icon-park-outline_dashboard-one.png" alt="" />
                        <a href=" /main/dashBoard.html">DashBoard</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/fluent_tray-item-remove-24-regular.png" alt="" />
                        <a href="/main/item.html">Items</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/Vector.png" alt="" />
                        <a href="/main/sales.html">Sales</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/Vector2.png" alt="" />
                        <a href="/main/invoice.html">Invoice</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/icon-park-outline_expenses-one.png" alt="" />
                        <a href="/main/expenses.html">Expenses</a>

                    </li>
                    <li class="d-flex">
                        <img src="/images/material-symbols_monitor-weight-loss-outline-sharp.png" alt="" />
                        <a href="/main/profit.html">Profit and Loss</a>
                    </li>
                    <li class="d-flex">
                        <img src="/images/settings_24px.png" alt="" />
                        <a>Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <main>
        <div class="main--heading">
            <!-- <a class="main-a">Availble Stock</a> -->
            <!-- <a href="/main/remaining.html">Out of stock</a> -->
        </div>
        <div class="table--body">
            <table class="list" id="customer-list">
                <thead>
                    <tr>
                        <th>NAME</th>

                        <th>PHONE</th>
                        <th>DEBT</th>
                        <th>DATE</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <!-- popup -->
        <div class="popup-customer--form">
            <form class="popup" onsubmit="onFormSubmit()">
                <div class="popoup--head">
                    <img src="/images/Close_MD2.png" alt="" class="customer--popup--close">
                </div>
                <h2 id="popup-title">New Customer</h2>
                <label for="new__customer-name">Add name*</label><label class="validation-error hide"
                    id="fullNameValidationError"> this field is requried</label>

                <input type="text" id="new--customer-name" name="new--customer-name">




                <label for="customer-number">
                    Phone
                    <input type="number" id="customer-number" name="stock-number">
                </label>

                <label for="stock-price">
                    Debt
                    <input type="text" id="debt" name="debt">
                </label>
                <label for="date">
                    Date
                    <input type="date" id="date" name="date">
                </label>

                <input id="popup-btn" type="submit" value="submit" class="customer--save">
            </form>


        </div>


        <!-- table -->

    </main>
    <aside>
        <div class="profile">
            <div class="profile--close"><img src="/images/Close_MD2.png" alt=""></div>
            <div class="profile-insert">
                <input type="file" id="file" accept="image/jpeg, image/png, image/jpg">
                <label for="file"><img src="/images/icons8-cameras-48.png" alt="" class="profile-input"></label>
                <div class="profile--top">
                    <img src="/images/blank-profile-picture-973460_1280.webp" class="profile--pic">
                </div>
                <div>
                    <h3 class="profile--username ">Deborah Allen</h3>
                    <p class="profile--email">deborahallen@gmail.com</p>
                </div>

            </div>
            <div>
                <ul>
                    <li class="profile--item">
                        <img src="/images/ri_notification-4-line.png" alt="" />
                        <p>Manage notifications</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_privacy-tip-outline-rounded.png" alt="" />
                        <p>Private Policy</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li class="profile--item">

                    <li class="profile--item">
                        <img src="/images/material-symbols_conditions.png" alt="" />
                        <p>Terms and Conditions</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item">
                        <img src="/images/material-symbols_contact-support-outline-rounded.png" alt="" />
                        <p>Support</p>
                        <span><img src="/images/icon-right.png" alt="" /></span>
                    </li>
                    <li class="profile--item logout">
                        <img src="/images/ic_round-logout.png" alt="" />
                        <p> Logout</p>


                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <script>
        // GET ELEMENTS
        const customerAddForm = document.querySelector(".popup-customer--form");
        const customerBtn = document.querySelector(".customer--add");
        const customerCloseBtn = document.querySelector(".customer--popup--close")
        const customerSaveBtn = document.querySelector(".customer--save")
        const table = document.getElementById("customer-list")
        const form = document.querySelector(".popup")

        const tbody = table.getElementsByTagName("tbody")[0];
        customerBtn.addEventListener("click", () => {

            customerAddForm.classList.add("show--customer--form");

        });
        customerCloseBtn.addEventListener("click", () => {

            customerAddForm.classList.remove("show--customer--form");
        });

        // search
        document.addEventListener("DOMContentLoaded", () => {

            const searchInput = document.querySelector("#sreach");
            const tablebody = document.getElementById("tbody");

            const rows = Array.from(tablebody.getElementsByTagName("tr"));

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase();
                const escapedQuery = RegExp.escape(query);

                rows.forEach((row) => {
                    const cells = row.querySelectorAll("td");
                    let found = false;

                    cells.forEach((cell) => {
                        const value = cell.textContent.toLowerCase().replace(",", "");

                        if (value.search(new RegExp(escapedQuery)) !== -1) {
                            found = true;
                        }
                    });

                    if (found) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            });
        });

        // Polyfill for RegExp.escape() method
        if (!RegExp.escape) {
            RegExp.escape = function (string) {
                return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
            };
        }
        form.addEventListener("submit", (e) => {
            e.preventDefault()
        })
        // Load data from localStorage
        const customersData = JSON.parse(localStorage.getItem("customersData")) || [];
        customersData.forEach((data) => {
            insertFormData(data);
        });
        function onFormSubmit() {
            if (validate()) {
                let cutomerDatas = readFormData();
                insertFormData(cutomerDatas);

                resetForm();
                customerAddForm.classList.remove("show--customer--form");
                // save to local storage
                const customersData = JSON.parse(localStorage.getItem("customersData")) || [];
                customersData.push(cutomerDatas);
                localStorage.setItem("customersData", JSON.stringify(customersData));
            }
        }
        function readFormData() {
            let cutomerDatas = {};
            cutomerDatas["customersname"] = document.getElementById("new--customer-name").value;
            cutomerDatas["customersnumber"] = document.getElementById("customer-number").value;
            cutomerDatas["debt"] = document.getElementById("debt").value;
            cutomerDatas["date"] = document.getElementById("date").value;

            return cutomerDatas;
        }
        function insertFormData(data) {
            let newRow = tbody.insertRow(tbody.length);
            cell1 = newRow.insertCell(0);
            cell1.innerHTML = data.customersname;
            cell2 = newRow.insertCell(1);
            cell2.innerHTML = data.customersnumber;
            cell3 = newRow.insertCell(2);
            cell3.innerHTML = data.debt;

            cell4 = newRow.insertCell(3);
            cell4.innerHTML = data.date;
            cell5 = newRow.insertCell(4);
            cell5.innerHTML = `<img onClick="onDelete(this)" src="/images/Close_MD2.png" alt="" class="popup--close">`;

        }
        function resetForm() {
            document.getElementById("new--customer-name").value = "";
            document.getElementById("customer-number").value = "";
            document.getElementById("debt").value = "";

        }
        function onDelete(td) {
            if (confirm("Are you sure you want to delete this record?")) {
                row = td.parentElement.parentElement;
                tbody.deleteRow(row.rowIndex - 1, 1);
                console.log(row)
                resetForm();

                // Remove data from localStorage
                const customersData = JSON.parse(localStorage.getItem("customersData")) || [];
                customersData.splice(row.rowIndex - 0, 1);
                localStorage.setItem("customersData", JSON.stringify(customersData));
            }
        }

        function validate() {
            isValid = true;
            if (document.getElementById("new--customer-name").value == "") {
                isValid = false;
                document.getElementById("fullNameValidationError").classList.remove("hide--invoice");
            } else {
                isValid = true;
                if (
                    document
                        .getElementById("fullNameValidationError")
                        .classList.contains("hide--invoice")
                )
                    document.getElementById("fullNameValidationError").classList.add("hide--invoice");
            }
            return isValid;
        }
        const getuserId = localStorage.getItem("user");
        const userId = JSON.parse(getuserId);

// Define the URL for the customers endpoint
const customersUrl = `https://amica-a.onrender.com/customers/${userId}/all`;

// Fetch the customers data
fetch(customersUrl)
  .then(response => {
    if (!response.ok) {
      throw new Error(`Error: ${response.status} - ${response.statusText}`);
    }
    return response.json();
  })
  .then(customersData => {
    // Process the retrieved customers data
    console.log(customersData); // You can replace this with your desired processing logic
  })
  .catch(error => {
    console.error('Error:', error);
  });


    </script>
</body>

</html>